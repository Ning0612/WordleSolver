name: Deploy Web Version to GitHub Pages

on:
  push:
    branches:
      - main
      - web-pyodide
    paths:
      - 'web/**'
      - 'src/**'
      - '.github/workflows/deploy-web.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# 防止多個部署同時進行
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build site
        run: |
          mkdir -p _site

          # 複製 web/ 目錄內容
          cp -r web/* _site/

          # 建立 src/ 目錄並複製 Python 模組
          mkdir -p _site/src
          cp src/*.py _site/src/

          # 確保字典檔案存在
          if [ ! -f _site/assets/five_letter_words.json ]; then
            echo "Converting dictionary to JSON..."
            python3 << 'EOF'
          import json
          with open('data/five_letter_words.txt', 'r', encoding='utf-8') as f:
              words = [line.strip().lower() for line in f if len(line.strip()) == 5 and line.strip().isalpha()]
          words = sorted(set(words))
          with open('_site/assets/five_letter_words.json', 'w', encoding='utf-8') as f:
              json.dump(words, f, ensure_ascii=False)
          print(f'Converted {len(words)} words to JSON')
          EOF
          fi

          # 顯示檔案結構
          echo "Site structure:"
          ls -R _site/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          retention-days: 1

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
